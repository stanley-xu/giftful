## Handoff Notes (2024-11-29)

### Session Summary: `/user/[userId]` Screen Refactoring

**What we accomplished:**

1. Created `FollowingContext` (`lib/contexts/FollowingContext.tsx`) to manage following state

   - Provides `follow(profile)`, `unfollow(userId)`, `isFollowingUser(userId)`
   - Handles API calls + optimistic updates with rollback
   - Provider wraps `app/(app)/user/_layout.tsx`

2. Updated `/user/index.tsx` to use context instead of local state

   - Added pull-to-refresh via `RefreshControl`

3. Route params optimization: `/user/index` passes `name` and `isFollowing` params to `[userId]`
   - Avoids refetching profile/follow status when navigating from Following tab

**iOS Large Title Header - Debugging Journey:**

The key problem: We wanted iOS native large title collapse behavior + custom background color + a collapsible profile card overlay.

What we tried:

1. Custom scroll-based header with `useAnimatedScrollHandler` - fought with native behavior
2. Various combinations of `headerTransparent`, `headerStyle.backgroundColor`, `headerBlurEffect`

**The tradeoff we made:**

- Setting `headerStyle.backgroundColor` breaks iOS large title collapse animation (known react-navigation bug: https://github.com/react-navigation/react-navigation/issues/11234)
- Solution: Use `headerTransparent: true` with `headerLargeTitleStyle.color` and `headerTitleStyle.color` set explicitly
- Lost: custom background color
- Gained: smooth native large title collapse

**Current state of `/user/[userId].tsx`:**

- Screen is in debug/minimal state with dummy list items
- ProfileCard overlay, WishlistSection, WishlistItemEditModal are **commented out**
- `useCollapsibleHeader` hook exists in `lib/hooks/useCollapsibleHeader.ts` (renamed to `useExpandableOverlay`)
  - Toggle-only (not scroll-based) - for the profile card overlay
  - Returns: `animatedOverlayStyle`, `animatedSpacerStyle`, `animatedChevronStyle`, `toggleExpand`, `isExpanded`

### Next Immediate Tasks:

1. **Restore commented-out elements** in `/user/[userId].tsx`:

   - `WishlistSection` with actual data
   - `WishlistItemEditModal`
   - `ProfileCard` overlay with `animatedOverlayStyle`

2. **Add drag-to-collapse for ProfileCard overlay**:

   - Currently only toggles via chevron button
   - User wants to be able to drag the card up to collapse it
   - Will need to add pan gesture back to the overlay (not the scroll)
   - Consider using `Gesture.Pan()` on the profile card that updates `expandProgress`

3. **Gesture coexistence**:
   - ScrollView handles content scrolling (drives native large title)
   - ProfileCard overlay needs separate pan gesture for drag-to-collapse
   - These should not conflict since overlay is absolutely positioned
